/**
 * Follow-Up Reminder Creator Processor
 *
 * Creates a follow-up reminder task for the CSM.
 * Schedules the task to resurface after a specified number of days.
 * Used for: "If customer doesn't respond in X days, follow up"
 *
 * Expected task.metadata:
 * {
 *   daysUntilReminder: number,
 *   reminderMessage: string,
 *   reminderPriority: 1-5,
 *   relatedAction: string (e.g., "Meeting Request Sent")
 * }
 */

const { createTask, getCustomer } = require('../services/database');

/**
 * Execute reminder creation
 *
 * @param {Object} context - Execution context
 * @param {Object} context.task - Task object
 * @param {Object} context.customer - Customer object
 * @param {Object} context.workflow - Workflow execution object
 * @returns {Object} Execution result
 */
async function execute({ task, customer, workflow }) {
  console.log(`   ⏰ Creating follow-up reminder for ${customer.name}...`);

  const {
    daysUntilReminder,
    reminderMessage,
    reminderPriority = 2,
    relatedAction
  } = task.metadata;

  if (!daysUntilReminder || !reminderMessage) {
    throw new Error('Missing required metadata: daysUntilReminder and reminderMessage');
  }

  try {
    // Calculate reminder date
    const reminderDate = new Date();
    reminderDate.setDate(reminderDate.getDate() + daysUntilReminder);

    console.log(`      Days Until Reminder: ${daysUntilReminder}`);
    console.log(`      Reminder Date: ${reminderDate.toLocaleDateString()}`);
    console.log(`      Related Action: ${relatedAction}`);

    // ─────────────────────────────────────────────────────────────────────
    // 1. Create Reminder Task
    // ─────────────────────────────────────────────────────────────────────

    const reminderTask = await createTask({
      workflow_execution_id: workflow.id,
      customer_id: customer.id,
      task_type: 'CSM_TASK',
      owner: 'CSM',
      action: 'Follow-up Reminder',
      description: reminderMessage,
      priority: reminderPriority,
      status: 'snoozed', // Start as snoozed, will resurface on reminder date
      snoozed_until: reminderDate,
      complexity: 'simple',
      estimated_completion_time: '15 minutes',
      metadata: {
        reminderType: 'follow-up',
        relatedAction,
        originalTaskId: task.id,
        createdBy: 'follow-up-reminder-creator',
        createdVia: workflow.workflow_name,
        autoGenerated: true
      },
      original_workflow_execution_id: workflow.id
    });

    console.log(`      ✅ Reminder task created: ${reminderTask.id}`);
    console.log(`      Will resurface: ${reminderDate.toLocaleString()}`);

    // ─────────────────────────────────────────────────────────────────────
    // 2. Set Calendar Reminder (Optional Integration)
    // ─────────────────────────────────────────────────────────────────────

    // In production, could integrate with calendar (Google Calendar, Outlook, etc.)
    // const calendarEvent = await createCalendarReminder({
    //   title: `Follow up: ${customer.name}`,
    //   description: reminderMessage,
    //   date: reminderDate,
    //   attendees: [workflow.assigned_csm_email]
    // });

    // ─────────────────────────────────────────────────────────────────────
    // 3. Create Notification (Low Priority, Info Only)
    // ─────────────────────────────────────────────────────────────────────

    // Note: This is an informational notification, not urgent
    // CSM will get notified when the reminder task resurfaces
    // No need for immediate notification

    // ─────────────────────────────────────────────────────────────────────
    // 4. Return Success
    // ─────────────────────────────────────────────────────────────────────

    return {
      success: true,
      message: `Follow-up reminder scheduled for ${reminderDate.toLocaleDateString()}`,
      reminderTaskId: reminderTask.id,
      reminderDate: reminderDate.toISOString(),
      daysUntilReminder,
      relatedAction
    };

  } catch (error) {
    console.error(`      ❌ Failed to create reminder: ${error.message}`);

    return {
      success: false,
      error: error.message,
      retryable: true // Database errors are typically retryable
    };
  }
}

/**
 * Validate task metadata before execution
 *
 * @param {Object} task - Task object
 * @returns {Object} Validation result
 */
function validate(task) {
  const { metadata } = task;

  if (!metadata) {
    return { valid: false, error: 'Missing metadata' };
  }

  if (!metadata.daysUntilReminder) {
    return { valid: false, error: 'Missing daysUntilReminder in metadata' };
  }

  if (typeof metadata.daysUntilReminder !== 'number' || metadata.daysUntilReminder < 1) {
    return { valid: false, error: 'daysUntilReminder must be a positive number' };
  }

  if (!metadata.reminderMessage) {
    return { valid: false, error: 'Missing reminderMessage in metadata' };
  }

  return { valid: true };
}

/**
 * Helper: Calculate business days (skip weekends)
 *
 * @param {number} days - Number of business days
 * @returns {Date} Calculated date
 */
function addBusinessDays(days) {
  const date = new Date();
  let addedDays = 0;

  while (addedDays < days) {
    date.setDate(date.getDate() + 1);
    // Skip weekends (0 = Sunday, 6 = Saturday)
    if (date.getDay() !== 0 && date.getDay() !== 6) {
      addedDays++;
    }
  }

  return date;
}

module.exports = {
  execute,
  validate,
  addBusinessDays
};
