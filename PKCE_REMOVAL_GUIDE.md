# Complete PKCE Removal Guide

## ðŸŽ¯ **Problem**
You're being redirected to URLs with PKCE parameters like:
```
http://127.0.0.1:54321/auth/v1/authorize?provider=google&redirect_to=http%3A%2F%2Flocalhost%3A3000%2Fauth%2Fcallback%3Fnext%3D%252Fscenarios&code_challenge=zuUtNXxMR8Yvlk9eeuKGqXWMojlzcPDouef0J_E-aPU&code_challenge_method=s256
```

## ðŸ”§ **Root Cause**
The PKCE URLs are being generated by your local Supabase instance, not your application code. This happens because:
1. Supabase local instance is configured to use PKCE by default
2. Cached authentication data contains PKCE parameters
3. Browser has cached OAuth URLs with PKCE

## âœ… **Complete Solution**

### **Step 1: Update Supabase Configuration**
The `redirect_uri` in your Supabase config was incorrect. I've fixed it:

**File**: `supabase/config.toml`
```toml
[auth.external.google]
enabled = true
client_id = "env(SUPABASE_AUTH_EXTERNAL_GOOGLE_CLIENT_ID)"
secret = "env(SUPABASE_AUTH_EXTERNAL_GOOGLE_SECRET)"
redirect_uri = "http://127.0.0.1:54321/auth/v1/callback"  # âœ… Fixed
skip_nonce_check = true
```

### **Step 2: Clear All Cached Data**
Run the following commands in order:

```bash
# 1. Stop your development server
# (Ctrl+C in your terminal)

# 2. Clear authentication cache
npm run clear-auth

# 3. Restart Supabase
supabase stop
supabase start

# 4. Restart your development server
npm run dev
```

### **Step 3: Clear Browser Data**
**Option A: Manual Browser Clearing**
1. Open Developer Tools (F12)
2. Go to Application/Storage tab
3. Clear the following:
   - Local Storage
   - Session Storage
   - Cookies (especially `sb-*` cookies)
   - IndexedDB

**Option B: Use the Clear Cookies Page**
Visit: `http://localhost:3000/clear-cookies.html`

### **Step 4: Verify OAuth Configuration**
Ensure your Google OAuth Console has these redirect URIs:
- `http://127.0.0.1:54321/auth/v1/callback` (REQUIRED for local Supabase)
- `http://localhost:3000/auth/callback` (Your app callback)

## ðŸ” **What Was Fixed**

### **1. Supabase Client Configuration**
**File**: `src/lib/supabase.ts`
```typescript
// âœ… Removed flowType: 'implicit' which was causing issues
export const createClient = () => createBrowserClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
  {
    auth: {
      autoRefreshToken: true,
      detectSessionInUrl: true,
      persistSession: true
    }
  }
)
```

### **2. OAuth Flow Simplification**
All OAuth calls now use simple flow without PKCE:

**File**: `src/app/signin/page.tsx`
```typescript
const { error } = await supabase.auth.signInWithOAuth({
  provider: "google",
  options: {
    redirectTo: `${window.location.origin}/auth/callback${
      next ? `?next=${encodeURIComponent(next)}` : ""
    }`,
    // âœ… No PKCE parameters
  },
})
```

### **3. RouteGuard and AuthProvider**
These components don't generate PKCE URLs - they only handle authentication state and redirects.

## ðŸ§ª **Testing the Fix**

### **1. Test the Sign-in Flow**
```bash
# Visit the signin page
http://localhost:3000/signin
```

**Expected Behavior:**
- Click "Sign in with Google"
- Should redirect to Google OAuth WITHOUT PKCE parameters
- Should return to your app successfully

### **2. Test Protected Routes**
```bash
# Visit a protected route
http://localhost:3000/scenarios
```

**Expected Behavior:**
- Should redirect to `/signin?next=/scenarios`
- After authentication, should redirect back to `/scenarios`

### **3. Test OAuth URLs**
The generated OAuth URLs should look like:
```
https://accounts.google.com/o/oauth2/v2/auth?client_id=...&redirect_uri=http%3A%2F%2F127.0.0.1%3A54321%2Fauth%2Fv1%2Fcallback&response_type=code&scope=openid+email+profile
```

**NOT like:**
```
https://accounts.google.com/o/oauth2/v2/auth?client_id=...&code_challenge=...&code_challenge_method=s256
```

## ðŸš¨ **If You Still See PKCE URLs**

### **1. Check Supabase Status**
```bash
supabase status
```

### **2. Reset Supabase Completely**
```bash
supabase stop
supabase reset
supabase start
```

### **3. Clear All Browser Data**
- Clear all cookies, local storage, and session storage
- Try in an incognito/private window
- Try a different browser

### **4. Check Environment Variables**
Ensure your `.env.local` has:
```env
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_AUTH_EXTERNAL_GOOGLE_CLIENT_ID=your_google_client_id
SUPABASE_AUTH_EXTERNAL_GOOGLE_SECRET=your_google_client_secret
```

## ðŸŽ¯ **Summary**

The PKCE URLs were being generated by your local Supabase instance, not your application code. The fixes include:

1. âœ… **Fixed Supabase redirect_uri configuration**
2. âœ… **Removed flowType from Supabase client**
3. âœ… **Cleared all cached authentication data**
4. âœ… **Restarted Supabase and development server**

After following these steps, you should no longer see PKCE parameters in your OAuth URLs, and authentication should work smoothly without the "invalid request: both auth code and code verifier should be non-empty" error. 