# Frontend Component Specification: Action Plan System

## Overview

This document specifies the frontend components needed to display and interact with Action Plans generated by the Discovery (and other renewal) workflows.

The Action Plan is the final step of each workflow, generating:
- **Process Summary**: What was completed, key decisions, metrics
- **AI Action Items**: Auto-executable tasks (CRM updates, reminders, tracking)
- **CSM Action Items**: Human-required tasks (meetings, calls, relationship building)
- **Timeline**: Sequential next steps with dates and owners
- **Next Workflow**: What workflow fires next and when

---

## Primary Component: ComprehensiveSummary

### Purpose

Display the complete action plan in a visually organized format based on the user's provided React component example.

### Component Location

```
src/components/workflows/ComprehensiveSummary.tsx
```

### Props Interface

```typescript
interface ComprehensiveSummaryProps {
  actionPlan: ActionPlan;
  customer: Customer;
  workflow: WorkflowExecution;
  onFinalizeActionPlan: () => Promise<void>;
  onEditTask: (taskId: string, taskType: 'ai' | 'csm') => void;
  allowEditing?: boolean;
}

interface ActionPlan {
  summary: {
    completedSteps: CompletedStep[];
    keyMetrics: Metric[];
  };
  aiTasks: AITask[];
  csmTasks: CSMTask[];
  timeline: TimelineEvent[];
  nextWorkflow?: NextWorkflow;
}

interface CompletedStep {
  stepName: string;
  status: 'complete' | 'partial';
  keyDecision?: string;
  value?: string;
}

interface Metric {
  label: string;
  value: string | number;
  unit?: string;
}

interface AITask {
  id: string;
  action: string;
  description: string;
  estimatedCompletionTime: string;
  status: 'queued' | 'running' | 'success' | 'failed';
  executedAt?: Date;
  executionResult?: {
    success: boolean;
    message?: string;
    error?: string;
  };
}

interface CSMTask {
  id: string;
  action: string;
  description: string;
  priority: 1 | 2 | 3 | 4 | 5;
  complexity: 'simple' | 'moderate' | 'complex';
  estimatedTime: string;
  dueDate?: Date;
  status: 'pending' | 'in_progress' | 'completed' | 'skipped';
  subTasks?: SubTask[];
}

interface SubTask {
  id: string;
  action: string;
  estimatedTime?: string;
  status: 'pending' | 'completed';
}

interface TimelineEvent {
  step: number;
  date: string;  // "Today", "Oct 1-3", "Within 2 weeks", or absolute date
  owner: 'AI' | 'CSM' | 'Customer';
  title: string;
  description: string;
  status: 'pending' | 'in_progress' | 'completed';
}

interface NextWorkflow {
  name: string;
  stage: string;
  estimatedDate: Date;
  daysFromNow: number;
  conditions: string[];
}

interface Customer {
  id: string;
  name: string;
  arr: number;
  daysUntilRenewal: number;
}

interface WorkflowExecution {
  id: string;
  workflow_name: string;
  stage: string;
  assigned_csm_id?: string;
}
```

---

## Component Sections

### 1. Process Completed Section

**Visual Design**: Green-themed, checkmark icons, 2-column grid

```tsx
<section>
  <h4>‚úì Process Completed</h4>
  <div className="bg-gray-50 rounded-lg p-4">
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {actionPlan.summary.completedSteps.map(step => (
        <div className="flex justify-between">
          <span className="text-gray-600">{step.stepName}:</span>
          <span className="font-medium text-green-600">
            ‚úì {step.keyDecision || step.value}
          </span>
        </div>
      ))}
    </div>
  </div>
</section>
```

**Data Source**: `actionPlan.summary.completedSteps`

**Example Data**:
```json
[
  {
    "stepName": "Contract Review",
    "status": "complete",
    "keyDecision": "Price Increase Cap: 8%"
  },
  {
    "stepName": "Pricing Strategy",
    "status": "complete",
    "value": "3% Increase Approved"
  }
]
```

---

### 2. AI Action Items Section

**Visual Design**: Blue-themed, robot icon, bullet list with status indicators

```tsx
<section>
  <h4>ü§ñ AI Action Items</h4>
  <div className="bg-blue-50 rounded-lg p-4">
    {actionPlan.aiTasks.map(task => (
      <div className="flex items-start gap-3 mb-3">
        <div className="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
        <div className="flex-1">
          <div className="font-medium text-blue-900">{task.action}</div>
          <div className="text-blue-700 text-sm">{task.description}</div>
          <div className="text-xs text-blue-600 mt-1">
            {task.status === 'queued' && `‚è±Ô∏è ${task.estimatedCompletionTime}`}
            {task.status === 'running' && `üîÑ Running...`}
            {task.status === 'success' && `‚úÖ Completed ${formatDate(task.executedAt)}`}
            {task.status === 'failed' && `‚ùå Failed: ${task.executionResult?.error}`}
          </div>
        </div>
      </div>
    ))}
  </div>
</section>
```

**Data Source**: `actionPlan.aiTasks`

**Example Data**:
```json
[
  {
    "id": "task_ai_1",
    "action": "Update Salesforce Contact Records",
    "description": "Change primary contact from Sarah Chen to Eric Estrada",
    "estimatedCompletionTime": "Within 15 minutes",
    "status": "queued"
  },
  {
    "id": "task_ai_2",
    "action": "Create Follow-up Reminder",
    "description": "Set reminder if no response within 5 business days",
    "estimatedCompletionTime": "Immediate",
    "status": "success",
    "executedAt": "2025-10-01T14:30:00Z"
  }
]
```

**Status Indicators**:
- `queued`: Clock icon + estimated time
- `running`: Spinning icon + "Running..."
- `success`: Green checkmark + completion timestamp
- `failed`: Red X + error message (with retry option)

---

### 3. CSM Action Items Section (NEW)

**Visual Design**: Purple/orange-themed, person icon, expandable complex tasks

```tsx
<section>
  <h4>üë§ CSM Action Items</h4>
  <div className="bg-purple-50 rounded-lg p-4">
    {actionPlan.csmTasks.map(task => (
      <div className="mb-4 border-b border-purple-200 last:border-0 pb-4 last:pb-0">
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <span className="font-medium text-purple-900">{task.action}</span>
              {task.complexity === 'complex' && (
                <span className="text-xs bg-purple-200 px-2 py-1 rounded">
                  {task.subTasks?.length} steps
                </span>
              )}
            </div>
            <div className="text-purple-700 text-sm mt-1">{task.description}</div>
            <div className="flex gap-3 text-xs text-purple-600 mt-2">
              <span>‚è±Ô∏è {task.estimatedTime}</span>
              <span>üìÖ {task.dueDate ? formatDate(task.dueDate) : 'No deadline'}</span>
              <span>üéØ Priority {task.priority}</span>
            </div>
          </div>
        </div>

        {/* Sub-tasks (if complex) */}
        {task.complexity === 'complex' && task.subTasks && (
          <div className="mt-3 ml-4 space-y-2">
            {task.subTasks.map((subTask, idx) => (
              <div className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={subTask.status === 'completed'}
                  onChange={() => handleSubTaskToggle(subTask.id)}
                />
                <span className={subTask.status === 'completed' ? 'line-through text-gray-500' : ''}>
                  {idx + 1}. {subTask.action}
                </span>
                {subTask.estimatedTime && (
                  <span className="text-xs text-gray-500">({subTask.estimatedTime})</span>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    ))}
  </div>
</section>
```

**Data Source**: `actionPlan.csmTasks`

**Example Data**:
```json
[
  {
    "id": "task_csm_1",
    "action": "Schedule and Conduct CFO Engagement Meeting",
    "description": "30-minute intro call with new CFO to discuss value and build relationship",
    "complexity": "complex",
    "priority": 1,
    "estimatedTime": "2 hours total",
    "dueDate": "2025-10-15",
    "status": "pending",
    "subTasks": [
      {
        "id": "subtask_1",
        "action": "Research CFO background and priorities",
        "estimatedTime": "30 minutes",
        "status": "pending"
      },
      {
        "id": "subtask_2",
        "action": "Prepare value-focused slide deck",
        "estimatedTime": "45 minutes",
        "status": "pending"
      },
      {
        "id": "subtask_3",
        "action": "Send meeting invitation",
        "estimatedTime": "15 minutes",
        "status": "pending"
      }
    ]
  },
  {
    "id": "task_csm_2",
    "action": "Create Value Realization Report",
    "description": "Document ROI and quantified value for pricing justification",
    "complexity": "moderate",
    "priority": 2,
    "estimatedTime": "1 hour",
    "status": "pending"
  }
]
```

---

### 4. Timeline Section

**Visual Design**: Orange-themed, numbered steps with dates, vertical timeline layout

```tsx
<section>
  <h4>üìÖ Next Steps & Timeline</h4>
  <div className="bg-orange-50 rounded-lg p-4">
    <div className="space-y-4">
      {actionPlan.timeline.map((event) => (
        <div className="flex items-start gap-4">
          {/* Step Number */}
          <div className="text-center">
            <div className="w-8 h-8 bg-orange-200 rounded-full flex items-center justify-center text-xs font-bold">
              {event.step}
            </div>
            <div className="text-xs text-orange-600 mt-1">{event.date}</div>
          </div>

          {/* Event Details */}
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <span className="font-medium text-orange-900">{event.title}</span>
              {event.owner === 'AI' && <span className="text-xs bg-blue-100 px-2 py-1 rounded">ü§ñ Automated</span>}
              {event.owner === 'CSM' && <span className="text-xs bg-purple-100 px-2 py-1 rounded">üë§ You</span>}
              {event.owner === 'Customer' && <span className="text-xs bg-green-100 px-2 py-1 rounded">üë• Customer</span>}
            </div>
            <div className="text-sm text-orange-700 mt-1">{event.description}</div>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>
```

**Data Source**: `actionPlan.timeline`

**Example Data**:
```json
[
  {
    "step": 1,
    "date": "Today",
    "owner": "AI",
    "title": "Update CRM Records",
    "description": "Automated updates to Salesforce contact and opportunity",
    "status": "pending"
  },
  {
    "step": 2,
    "date": "Within 2-3 business days",
    "owner": "Customer",
    "title": "Respond to Meeting Request",
    "description": "CFO should respond to meeting invitation",
    "status": "pending"
  },
  {
    "step": 3,
    "date": "Oct 1-3",
    "owner": "CSM",
    "title": "Conduct Renewal Meeting",
    "description": "30-minute strategic discussion",
    "status": "pending"
  }
]
```

---

### 5. Key Metrics Section

**Visual Design**: 3-column grid, card-style metrics

```tsx
<section>
  <h4>Key Metrics & Targets</h4>
  <div className="grid grid-cols-3 gap-4 text-center">
    {actionPlan.summary.keyMetrics.map(metric => (
      <div className="bg-gray-50 p-3 rounded-lg">
        <div className="text-lg font-bold text-gray-900">
          {metric.value}{metric.unit}
        </div>
        <div className="text-xs text-gray-600">{metric.label}</div>
      </div>
    ))}
  </div>
</section>
```

**Data Source**: `actionPlan.summary.keyMetrics`

**Example Data**:
```json
[
  { "label": "Target ARR", "value": "$265,000", "unit": "" },
  { "label": "Price Increase", "value": "6.8", "unit": "%" },
  { "label": "Days to Renewal", "value": "165", "unit": "days" }
]
```

---

### 6. Next Workflow Section (NEW)

**Visual Design**: Info card with workflow name, date, and conditions

```tsx
{actionPlan.nextWorkflow && (
  <section>
    <h4>üîÑ Next Workflow Scheduled</h4>
    <div className="bg-indigo-50 rounded-lg p-4">
      <div className="flex items-center justify-between">
        <div>
          <div className="font-medium text-indigo-900">{actionPlan.nextWorkflow.name}</div>
          <div className="text-sm text-indigo-700">Stage: {actionPlan.nextWorkflow.stage}</div>
        </div>
        <div className="text-right">
          <div className="font-medium text-indigo-900">
            {formatDate(actionPlan.nextWorkflow.estimatedDate)}
          </div>
          <div className="text-xs text-indigo-600">
            ({actionPlan.nextWorkflow.daysFromNow} days from now)
          </div>
        </div>
      </div>

      {actionPlan.nextWorkflow.conditions.length > 0 && (
        <div className="mt-3 pt-3 border-t border-indigo-200">
          <div className="text-sm text-indigo-700 font-medium mb-2">Trigger Conditions:</div>
          <ul className="text-sm text-indigo-600 space-y-1">
            {actionPlan.nextWorkflow.conditions.map(condition => (
              <li>‚Ä¢ {condition}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  </section>
)}
```

**Data Source**: `actionPlan.nextWorkflow`

**Example Data**:
```json
{
  "name": "Prepare Renewal",
  "stage": "Prepare",
  "estimatedDate": "2025-11-15T00:00:00Z",
  "daysFromNow": 30,
  "conditions": [
    "Discovery action items completed",
    "CFO relationship established",
    "Value documentation finalized"
  ]
}
```

---

## Action Buttons

### Finalize Action Plan Button

**Behavior**:
1. Shows confirmation modal: "This will create all AI and CSM tasks. Continue?"
2. On confirm, calls `onFinalizeActionPlan()` prop
3. Backend creates all tasks in database
4. AI tasks with `executeImmediately: true` start running
5. CSM tasks appear in task dashboard
6. Next workflow gets scheduled

```tsx
<div className="mt-6 flex gap-3 justify-end">
  <button
    onClick={handleEditTasks}
    className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
  >
    Edit Tasks
  </button>
  <button
    onClick={handleFinalizeActionPlan}
    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
  >
    Finalize Action Plan
  </button>
</div>
```

---

## API Integration

### GET Action Plan Data

**Endpoint**: `GET /api/workflows/executions/:executionId/action-plan`

**Response**:
```json
{
  "success": true,
  "actionPlan": {
    "summary": { ... },
    "aiTasks": [ ... ],
    "csmTasks": [ ... ],
    "timeline": [ ... ],
    "nextWorkflow": { ... }
  },
  "customer": { ... },
  "workflow": { ... }
}
```

### POST Finalize Action Plan

**Endpoint**: `POST /api/workflows/executions/:executionId/action-plan/finalize`

**Request Body**: None (action plan already generated)

**Response**:
```json
{
  "success": true,
  "tasksCreated": {
    "ai": 3,
    "csm": 5,
    "total": 8
  },
  "nextWorkflowScheduled": true,
  "nextWorkflowDate": "2025-11-15T00:00:00Z"
}
```

**Side Effects**:
- Creates all AI tasks with `auto_execute: true, execution_status: 'queued'`
- Creates all CSM tasks (with sub-tasks if complex)
- Queues AI tasks for execution (5-minute cron job picks them up)
- Creates notification for CSM
- Schedules next workflow trigger
- Marks workflow execution as `completed_with_pending_tasks`

---

## Real-Time Updates

### AI Task Status Updates

Use polling or WebSocket to update AI task statuses in real-time:

```typescript
useEffect(() => {
  const pollInterval = setInterval(async () => {
    const updatedTasks = await fetchAITaskStatuses(actionPlan.aiTasks.map(t => t.id));
    setActionPlan(prev => ({
      ...prev,
      aiTasks: prev.aiTasks.map(task =>
        updatedTasks[task.id] || task
      )
    }));
  }, 10000); // Poll every 10 seconds

  return () => clearInterval(pollInterval);
}, [actionPlan.aiTasks]);
```

### Status Display Logic

```typescript
function getAITaskStatusDisplay(task: AITask) {
  switch (task.status) {
    case 'queued':
      return {
        icon: '‚è±Ô∏è',
        color: 'text-gray-600',
        message: `Will complete ${task.estimatedCompletionTime}`
      };
    case 'running':
      return {
        icon: 'üîÑ',
        color: 'text-blue-600',
        message: 'Running...',
        animated: true
      };
    case 'success':
      return {
        icon: '‚úÖ',
        color: 'text-green-600',
        message: `Completed ${formatDate(task.executedAt)}`
      };
    case 'failed':
      return {
        icon: '‚ùå',
        color: 'text-red-600',
        message: `Failed: ${task.executionResult?.error}`,
        retryable: true
      };
  }
}
```

---

## Summary

**Component Hierarchy**:
```
ComprehensiveSummary
‚îú‚îÄ‚îÄ ProcessCompletedSection
‚îú‚îÄ‚îÄ AIActionItemsSection
‚îÇ   ‚îî‚îÄ‚îÄ AITaskCard (x N)
‚îú‚îÄ‚îÄ CSMActionItemsSection
‚îÇ   ‚îî‚îÄ‚îÄ CSMTaskCard (x N)
‚îÇ       ‚îî‚îÄ‚îÄ SubTaskCheckbox (x N, if complex)
‚îú‚îÄ‚îÄ TimelineSection
‚îÇ   ‚îî‚îÄ‚îÄ TimelineEvent (x N)
‚îú‚îÄ‚îÄ KeyMetricsSection
‚îÇ   ‚îî‚îÄ‚îÄ MetricCard (x 3)
‚îú‚îÄ‚îÄ NextWorkflowSection
‚îî‚îÄ‚îÄ ActionButtons
    ‚îú‚îÄ‚îÄ EditTasksButton
    ‚îî‚îÄ‚îÄ FinalizeActionPlanButton
```

**Key Features**:
- ‚úÖ Visual hierarchy with color-coded sections
- ‚úÖ Real-time AI task status updates
- ‚úÖ Sub-task support for complex CSM tasks
- ‚úÖ Timeline with owner indicators (AI/CSM/Customer)
- ‚úÖ Next workflow trigger information
- ‚úÖ Finalize action to create all tasks

**Integration Points**:
- Appears as final step in workflow execution UI
- Connects to task management system (Checkpoint 3 components)
- Triggers AI task execution queue
- Schedules next workflow
- Creates notifications

This spec provides everything the frontend developer needs to build the Action Plan display matching your provided React component example.
